commit 13a88ff088ab99f792d3022d3692299ce3f934e7
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Wed Feb 4 21:20:54 2026 +0100

    feat: Add sales, order requests, and purchases pages, including an AI dosing assistant and barcode scanning functionality.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 4191a36..2b88c5a 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -57,7 +57,7 @@ import { InvoiceTemplate } from "@/components/ui/invoice"
 import { useAuth } from "@/hooks/use-auth"
 import { Button, buttonVariants } from "@/components/ui/button"
 import { BarcodeScanner } from "@/components/ui/barcode-scanner"
-import { ScanBarcode, PlusCircle, X, PackageSearch, ArrowLeftRight, Printer, User as UserIcon, AlertTriangle, TrendingUp, FilePlus, UserPlus, Package, Thermometer, BrainCircuit, WifiOff, Wifi, Replace, Percent, Pencil, Trash2, ArrowRight, FileText, Calculator, Search, Plus, Minus, Star, History, Stethoscope, Pill } from "lucide-react"
+import { ScanBarcode, PlusCircle, X, PackageSearch, ArrowLeftRight, Printer, User as UserIcon, AlertTriangle, TrendingUp, FilePlus, UserPlus, Package, Thermometer, BrainCircuit, WifiOff, Wifi, Replace, Percent, Pencil, Trash2, ArrowRight, FileText, Calculator, Search, Plus, Minus, Star, History, Stethoscope, Pill, Loader2 } from "lucide-react"
 import { calculateDose, type DoseCalculationInput } from "@/ai/flows/dose-calculator-flow"
 import { Skeleton } from "@/components/ui/skeleton"
 import { useOnlineStatus } from "@/hooks/use-online-status"
@@ -1051,6 +1051,7 @@ export default function SalesPage() {
     }, [doctorId, doctorList]);
 
     const handleCheckout = async () => {
+        if (isProcessingSale) return;
         if (cart.length === 0) {
             toast({ title: "السلة فارغة", description: "أضف منتجات إلى السلة قبل إتمام العملية.", variant: "destructive" })
             return;
@@ -1983,7 +1984,14 @@ export default function SalesPage() {
                                 </div>
                                 <div className="flex gap-2 mt-4">
                                     <Button size="lg" className="flex-1" onClick={handleCheckout} disabled={cart.length === 0 || isProcessingSale} variant={saleIdToUpdate ? 'default' : 'success'}>
-                                        {isProcessingSale ? "جاري الحفظ..." : (saleIdToUpdate ? 'تحديث الفاتورة' : (mode === 'return' ? 'إتمام الاسترجاع' : 'إتمام العملية'))}
+                                        {isProcessingSale ? (
+                                            <>
+                                                <Loader2 className="me-2 h-4 w-4 animate-spin" />
+                                                جاري الحفظ...
+                                            </>
+                                        ) : (
+                                            saleIdToUpdate ? 'تحديث الفاتورة' : (mode === 'return' ? 'إتمام الاسترجاع' : 'إتمام العملية')
+                                        )}
                                     </Button>
                                 </div>
                                 {activeInvoices.length === 1 && activeInvoice.cart.length > 0 && (

commit e954a0e44ce251852dbc6c83901c810d874d51d2
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Mon Feb 2 19:18:26 2026 +0100

    feat: add sales page with AI dosing assistant, barcode conflict resolution, and invoice printing.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 44c5549..4191a36 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -351,7 +351,6 @@ function FavoritesPopover({ onSelect }: { onSelect: (med: Medication) => void })
 
                     <div className="space-y-2">
                         {searchTerm.length > 1 ? (
-                            // Search results
                             searchResults.length > 0 ? searchResults.map(med => (
                                 <div key={med.id} className="p-2 flex items-center justify-between hover:bg-accent rounded-md text-sm">
                                     <span>{med.name}</span>

commit 1dfb05439af2eae652291741e091fa005adf7b5a
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Mon Feb 2 19:02:42 2026 +0100

    feat: implement sales page with point-of-sale functionality, barcode scanning, dosing assistant, and invoice printing.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 410e680..44c5549 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -1092,7 +1092,7 @@ export default function SalesPage() {
         const controlledSubstances = settings.controlled_substances || [];
         const drugsInCart = cart.filter(item =>
             !item.is_return && item.scientific_names?.some(scName =>
-                controlledSubstances.map(cs => cs.toLowerCase()).includes(scName.toLowerCase())
+                scName != null && controlledSubstances.map(cs => cs.toLowerCase()).includes(scName.toLowerCase())
             )
         );
 

commit d1659d287eb0792071c6836ca620cca591698c52
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Mon Feb 2 18:07:48 2026 +0100

    feat: Implement dedicated pages for managing purchases and sales.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 9624d8b..410e680 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -238,11 +238,13 @@ function DosingAssistant({ cartItems }: { cartItems: SaleItem[] }) {
 
 function BarcodeConflictDialog({ open, onOpenChange, conflictingMeds, onSelect }: { open: boolean, onOpenChange: (open: boolean) => void, conflictingMeds: Medication[], onSelect: (med: Medication) => void }) {
     const sortedMeds = React.useMemo(() => {
-        return [...conflictingMeds].sort((a, b) => {
-            if (!a.expiration_date) return 1;
-            if (!b.expiration_date) return -1;
-            return new Date(a.expiration_date).getTime() - new Date(b.expiration_date).getTime();
-        });
+        return [...conflictingMeds]
+            .filter(med => (med.stock || 0) > 0)
+            .sort((a, b) => {
+                if (!a.expiration_date) return 1;
+                if (!b.expiration_date) return -1;
+                return new Date(a.expiration_date).getTime() - new Date(b.expiration_date).getTime();
+            });
     }, [conflictingMeds]);
 
     return (

commit 7c15d9a87ceed78bfdbc22a11357e70060e6ed36
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Sun Feb 1 22:47:38 2026 +0100

    feat: Add core data types, initial data structures, and sales and settings pages.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 08558d9..9624d8b 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -726,12 +726,15 @@ export default function SalesPage() {
         }
     }, [fullInventory, mode]);
 
-    const addToCart = React.useCallback((medication: Medication, unitType: 'box' | 'strip' = 'strip') => {
+    const addToCart = React.useCallback((medication: Medication, unitType?: 'box' | 'strip') => {
+        const defaultUnit = unitType || settings.default_unit_type || 'strip';
+        let resolvedUnitType: 'box' | 'strip' = defaultUnit as 'box' | 'strip';
+
         // Force box unit if strips_per_box is 1
         // Force box unit if strips_per_box is 1 AND the setting is enabled
         const shouldForceBox = Number(medication.strips_per_box || 1) === 1 && (settings.force_box_if_single_strip ?? true);
         if (shouldForceBox) {
-            unitType = 'box';
+            resolvedUnitType = 'box';
         }
 
         // Expiry check
@@ -755,24 +758,24 @@ export default function SalesPage() {
             const existingItem = invoice.cart.find(item =>
                 item.id === medication.id &&
                 item.is_return === (mode === 'return') &&
-                item.unit_type === unitType
+                item.unit_type === resolvedUnitType
             )
 
             if (existingItem) {
                 // Calculate available stock based on unit type
-                const availableStock = unitType === 'box'
+                const availableStock = resolvedUnitType === 'box'
                     ? Math.floor(medication.stock / (medication.strips_per_box || 1))
                     : medication.stock;
 
                 if (Number(existingItem.quantity) >= Number(availableStock) && mode !== 'return') {
-                    toast({ variant: 'destructive', title: 'كمية غير كافية', description: `لا يمكن إضافة المزيد من ${medication.name}. الرصيد المتوفر: ${availableStock} ${unitType === 'box' ? 'علبة' : 'شريط'}` });
+                    toast({ variant: 'destructive', title: 'كمية غير كافية', description: `لا يمكن إضافة المزيد من ${medication.name}. الرصيد المتوفر: ${availableStock} ${resolvedUnitType === 'box' ? 'علبة' : 'شريط'}` });
                     success = false;
                     return invoice;
                 }
                 return {
                     ...invoice,
                     cart: invoice.cart.map(item =>
-                        item.id === medication.id && item.is_return === (mode === 'return') && item.unit_type === unitType
+                        item.id === medication.id && item.is_return === (mode === 'return') && item.unit_type === resolvedUnitType
                             ? { ...item, quantity: item.quantity + 1 }
                             : item
                     )
@@ -780,7 +783,7 @@ export default function SalesPage() {
             }
 
             // Determine price based on unit type
-            const itemPrice = unitType === 'box'
+            const itemPrice = resolvedUnitType === 'box'
                 ? (medication.box_sell_price || 0)
                 : (medication.strip_sell_price || 0);
 
@@ -793,11 +796,11 @@ export default function SalesPage() {
                     scientific_names: medication.scientific_names,
                     quantity: 1,
                     price: itemPrice,
-                    purchase_price: unitType === 'box' ? (medication.box_purchase_price || 0) : (medication.strip_purchase_price || 0),
+                    purchase_price: resolvedUnitType === 'box' ? (medication.box_purchase_price || 0) : (medication.strip_purchase_price || 0),
                     expiration_date: medication.expiration_date,
                     is_return: mode === 'return',
                     dosage_form: medication.dosage_form,
-                    unit_type: unitType,
+                    unit_type: resolvedUnitType,
                 }]
             }
         });
@@ -1094,7 +1097,7 @@ export default function SalesPage() {
         if (drugsInCart.length > 0) {
             // تحقق إذا كان الرمز قد تم تأكيده بالفعل
             if (isControlledDrugConfirmed) {
-                setIsCheckoutOpen(true);
+                await handleFinalizeSale();
                 setIsControlledDrugConfirmed(false); // إعادة تعيين الحالة للاستخدام المستقبلي
             } else {
                 setControlledDrugsInCart(drugsInCart.map(d => d.name));
@@ -1103,7 +1106,7 @@ export default function SalesPage() {
                 return;
             }
         } else {
-            setIsCheckoutOpen(true);
+            await handleFinalizeSale();
         }
     }
 
@@ -1152,7 +1155,7 @@ export default function SalesPage() {
         setControlledDrugPin('');
         setIsControlledDrugPinOpen(false);
         setIsControlledDrugConfirmed(true);
-        setIsCheckoutOpen(true);
+        await handleFinalizeSale();
         toast({
             variant: "default",
             title: "تنبيه: دواء خاضع للرقابة",
@@ -1958,88 +1961,29 @@ export default function SalesPage() {
                                         </DialogTrigger>
                                         <DosingAssistant cartItems={cart} />
                                     </Dialog>
-                                    <Dialog open={isCheckoutOpen} onOpenChange={setIsCheckoutOpen}>
-                                        <DialogTrigger asChild>
-                                            <Button size="lg" className="flex-1" onClick={handleCheckout} disabled={cart.length === 0 || isProcessingSale} variant={saleIdToUpdate ? 'default' : 'success'}>
-                                                {isProcessingSale ? "جاري الحفظ..." : (saleIdToUpdate ? 'تحديث الفاتورة' : (mode === 'return' ? 'إتمام الاسترجاع' : 'إتمام العملية'))}
-                                            </Button>
-                                        </DialogTrigger>
-                                        <DialogContent>
-                                            <DialogHeader>
-                                                <DialogTitle>{saleIdToUpdate ? 'تأكيد التعديل' : 'تأكيد الفاتورة'}</DialogTitle>
-                                            </DialogHeader>
-                                            <div className="space-y-4">
-                                                <div className="max-h-64 overflow-y-auto p-1">
-                                                    <Table>
-                                                        <TableHeader>
-                                                            <TableRow>
-                                                                <TableHead>المنتج</TableHead>
-                                                                <TableHead className="text-center">الكمية</TableHead>
-                                                                <TableHead className="text-left">السعر</TableHead>
-                                                            </TableRow>
-                                                        </TableHeader>
-                                                        <TableBody>
-                                                            {cart.map(item => (
-                                                                <TableRow key={`${item.id}-${item.is_return}-${item.unit_type || 'strip'}`} className={cn(item.is_return && "text-destructive")}>
-                                                                    <TableCell>{item.name} {item.is_return && "(مرتجع)"}</TableCell>
-                                                                    <TableCell className="text-center font-mono">{item.quantity}</TableCell>
-                                                                    <TableCell className="text-left font-mono">{((item.is_return ? -1 : 1) * (item.price || 0) * (item.quantity || 0)).toLocaleString()}</TableCell>
-                                                                </TableRow>
-                                                            ))}
-                                                        </TableBody>
-                                                    </Table>
-                                                </div>
-                                                <Separator />
-                                                <div className="space-y-2 text-sm font-mono">
-                                                    {selectedPatient &&
-                                                        <div className="flex justify-between">
-                                                            <span>المريض:</span>
-                                                            <span>{selectedPatient.name}</span>
-                                                        </div>
-                                                    }
-                                                    <div className="flex justify-between">
-                                                        <span>المجموع:</span>
-                                                        <span>{subtotal.toLocaleString()}</span>
-                                                    </div>
-                                                    <div className="flex justify-between">
-                                                        <span>الخصم:</span>
-                                                        <span>-{discountAmount.toLocaleString()}</span>
-                                                    </div>
-                                                    {/* <div className={cn("flex justify-between", finalProfit >= 0 ? "text-green-600" : "text-destructive")}>
-                                                        <span>الربح الصافي:</span>
-                                                        <span>{finalProfit.toLocaleString()}</span>
-                                                    </div> */}
-                                                    <div className="flex justify-between font-bold text-lg">
-                                                        <span>الإجمالي النهائي:</span>
-                                                        <span>{finalTotal.toLocaleString()}</span>
-                                                    </div>
-                                                </div>
-                                                <Separator />
-                                                <RadioGroup defaultValue="cash" value={paymentMethod} onValueChange={handlePaymentMethodChange} className="grid grid-cols-3 gap-4 pt-2">
-                                                    <Label htmlFor="payment-cash" className="flex items-center justify-center gap-2 cursor-pointer rounded-md border p-3 has-[input:checked]:bg-primary has-[input:checked]:text-primary-foreground">
-                                                        <RadioGroupItem value="cash" id="payment-cash" />
-                                                        نقداً
-                                                    </Label>
-                                                    <Label htmlFor="payment-card" className="flex items-center justify-center gap-2 cursor-pointer rounded-md border p-3 has-[input:checked]:bg-primary has-[input:checked]:text-primary-foreground">
-                                                        <RadioGroupItem value="card" id="payment-card" />
-                                                        بطاقة
-                                                    </Label>
-                                                    <Label htmlFor="payment-credit" className="flex items-center justify-center gap-2 cursor-pointer rounded-md border p-3 has-[input:checked]:bg-primary has-[input:checked]:text-primary-foreground">
-                                                        <RadioGroupItem value="credit" id="payment-credit" />
-                                                        آجل (دين)
-                                                    </Label>
-                                                </RadioGroup>
-                                            </div>
-                                            <DialogFooter className='sm:space-x-reverse'>
-                                                <DialogClose asChild>
-                                                    <Button variant="outline" disabled={isProcessingSale}>إلغاء</Button>
-                                                </DialogClose>
-                                                <Button onClick={handleFinalizeSale} disabled={isProcessingSale} variant={saleIdToUpdate ? 'default' : 'success'}>
-                                                    {isProcessingSale ? 'جاري الحفظ...' : (saleIdToUpdate ? 'تأكيد التعديل' : (mode === 'return' ? 'تأكيد الاسترجاع' : 'تأكيد البيع'))}
-                                                </Button>
-                                            </DialogFooter>
-                                        </DialogContent>
-                                    </Dialog>
+                                </div>
+                                <Separator className="my-2" />
+                                <div className="space-y-4">
+                                    <Label className="text-sm font-bold">طريقة الدفع</Label>
+                                    <RadioGroup defaultValue="cash" value={paymentMethod} onValueChange={handlePaymentMethodChange} className="grid grid-cols-3 gap-4 pt-2">
+                                        <Label htmlFor="payment-cash" className="flex items-center justify-center gap-2 cursor-pointer rounded-md border p-3 has-[input:checked]:bg-primary has-[input:checked]:text-primary-foreground">
+                                            <RadioGroupItem value="cash" id="payment-cash" />
+                                            نقداً
+                                        </Label>
+                                        <Label htmlFor="payment-card" className="flex items-center justify-center gap-2 cursor-pointer rounded-md border p-3 has-[input:checked]:bg-primary has-[input:checked]:text-primary-foreground">
+                                            <RadioGroupItem value="card" id="payment-card" />
+                                            بطاقة
+                                        </Label>
+                                        <Label htmlFor="payment-credit" className="flex items-center justify-center gap-2 cursor-pointer rounded-md border p-3 has-[input:checked]:bg-primary has-[input:checked]:text-primary-foreground">
+                                            <RadioGroupItem value="credit" id="payment-credit" />
+                                            آجل (دين)
+                                        </Label>
+                                    </RadioGroup>
+                                </div>
+                                <div className="flex gap-2 mt-4">
+                                    <Button size="lg" className="flex-1" onClick={handleCheckout} disabled={cart.length === 0 || isProcessingSale} variant={saleIdToUpdate ? 'default' : 'success'}>
+                                        {isProcessingSale ? "جاري الحفظ..." : (saleIdToUpdate ? 'تحديث الفاتورة' : (mode === 'return' ? 'إتمام الاسترجاع' : 'إتمام العملية'))}
+                                    </Button>
                                 </div>
                                 {activeInvoices.length === 1 && activeInvoice.cart.length > 0 && (
                                     <AlertDialog>
diff --git a/src/lib/types.ts b/src/lib/types.ts
index edc6ee2..6426560 100644
--- a/src/lib/types.ts
+++ b/src/lib/types.ts
@@ -358,6 +358,7 @@ export type AppSettings = {
   favorite_med_ids?: string[];
   expense_categories?: { id: string; name: string }[];
   force_box_if_single_strip?: boolean;
+  default_unit_type?: 'box' | 'strip';
 }
 
 export type TrashItem = {

commit 95e0e2528b2e893a17d99b7a09284bb0472e6b35
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Sun Feb 1 21:39:15 2026 +0100

    feat: Add `use-auth` hook for comprehensive authentication and pharmacy data management, and introduce the sales page.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 3e4dc73..08558d9 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -911,7 +911,7 @@ export default function SalesPage() {
         setNameSearchTerm(value);
 
         if (value.length > 0) {
-            const results = await searchAllInventory(value);
+            const results = await searchAllInventory(value, { stock_status: 'has_stock' });
             setNameSuggestions(results);
         } else {
             setNameSuggestions([]);
diff --git a/src/hooks/use-auth.tsx b/src/hooks/use-auth.tsx
index a86bc45..8940eb9 100644
--- a/src/hooks/use-auth.tsx
+++ b/src/hooks/use-auth.tsx
@@ -99,7 +99,7 @@ interface AuthContextType {
     bulkAddOrUpdateInventory: (items: Partial<Medication>[]) => Promise<{ new_count: number; updated_count?: number; } | null>;
     bulkUploadInventory: (file: File) => Promise<{ new_count: number; updated_count?: number; processed_medications?: number; } | null>;
     getPaginatedInventory: (page: number, perPage: number, search: string, filters: Record<string, any>) => Promise<PaginatedResponse<Medication>>;
-    searchAllInventory: (search: string) => Promise<Medication[]>;
+    searchAllInventory: (search: string, filters?: Record<string, any>) => Promise<Medication[]>;
     toggleFavoriteMedication: (medId: string) => Promise<void>;
     searchInOtherBranches: (medicationName: string) => Promise<BranchInventory[]>;
     getRandomStocktakeItems: (limit: number) => Promise<Medication[]>;
@@ -873,9 +873,9 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
         }
     }, []);
 
-    const searchAllInventory = React.useCallback(async (search: string) => {
+    const searchAllInventory = React.useCallback(async (search: string, filters: Record<string, any> = {}) => {
         try {
-            const params = new URLSearchParams({ search });
+            const params = new URLSearchParams({ search, ...filters });
             const result = await apiRequest(`/medications?${params.toString()}`);
             // The API returns paginated data even without paginate=true, so we access .data
             return result.data || result;

commit 638c0a0026cac0e6994e11cc9972caff88ff9809
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Sat Jan 31 17:39:04 2026 +0100

    feat: Implement a new sales reports page with filtering, pagination, printing, and export capabilities, introduce a `useAuth` hook, and add a service worker.

diff --git a/src/app/reports/page.tsx b/src/app/reports/page.tsx
index e6c96f4..665e7e8 100644
--- a/src/app/reports/page.tsx
+++ b/src/app/reports/page.tsx
@@ -106,7 +106,7 @@ const printElement = (element: HTMLElement, title: string = 'Print') => {
 };
 
 export default function ReportsPage() {
-    const { currentUser, users, scopedData, deleteSale, updateActiveInvoice, getPaginatedSales, verifyPin, switchToInvoice, getPaginatedPatients, getDoctors, searchAllPatients } = useAuth();
+    const { currentUser, users, scopedData, deleteSale, updateActiveInvoice, getPaginatedSales, verifyPin, switchToInvoice, getPaginatedPatients, getDoctors, searchAllPatients, exportSales } = useAuth();
     const [settings] = scopedData.settings;
     const [sales, setSales] = React.useState<Sale[]>([]);
     const [totalPages, setTotalPages] = React.useState(1);
@@ -292,6 +292,12 @@ export default function ReportsPage() {
         }
     };
 
+    const handleExport = () => {
+        exportSales(searchTerm, dateFrom, dateTo, employeeId, paymentMethod, doctorId, patientId);
+    };
+
+
+
 
 
     // Removed client-side calculation. Using API values.
@@ -410,7 +416,12 @@ export default function ReportsPage() {
 
             <Card>
                 <CardHeader>
-                    <CardTitle>سجل المبيعات</CardTitle>
+                    <div className="flex justify-between items-center">
+                        <CardTitle>سجل المبيعات</CardTitle>
+                        <Button variant="outline" onClick={handleExport} className="">
+                            تصدير Excel
+                        </Button>
+                    </div>
                     <CardDescription>عرض وطباعة جميع فواتير المبيعات السابقة. اضغط على الصف لعرض التفاصيل.</CardDescription>
                     <div className="pt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
                         <div className="space-y-2 lg:col-span-2">
diff --git a/src/hooks/use-auth.tsx b/src/hooks/use-auth.tsx
index eb17a5d..a86bc45 100644
--- a/src/hooks/use-auth.tsx
+++ b/src/hooks/use-auth.tsx
@@ -274,6 +274,7 @@ interface AuthContextType {
     currentDoctor: Doctor | null;
     isAuthenticatedDoctor: boolean;
     impersonateUser: (userId: string) => Promise<boolean>;
+    exportSales: (search: string, dateFrom: string, dateTo: string, employeeId: string, paymentMethod: string, doctorId: string, patientId: string) => Promise<void>;
 }
 export interface ScopedDataContextType {
     inventory: [Medication[], React.Dispatch<React.SetStateAction<Medication[]>>];
@@ -1043,6 +1044,46 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
         }
     }, []);
 
+    const exportSales = React.useCallback(async (search: string, dateFrom: string, dateTo: string, employeeId: string, paymentMethod: string, doctorId: string, patientId: string) => {
+        try {
+            const params = new URLSearchParams({
+                search: search,
+                date_from: dateFrom,
+                date_to: dateTo,
+                employee_id: employeeId,
+                payment_method: paymentMethod,
+                doctor_id: doctorId,
+                patient_id: patientId
+            });
+
+            const token = localStorage.getItem('authToken');
+            const response = await fetch(`${API_URL}/sales/export?${params.toString()}`, {
+                headers: {
+                    'Authorization': `Bearer ${token}`,
+                    'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
+                }
+            });
+
+            if (!response.ok) throw new Error('Export failed');
+
+            const blob = await response.blob();
+            const url = window.URL.createObjectURL(blob);
+            const a = document.createElement('a');
+            a.href = url;
+            a.download = `sales_report_${new Date().toISOString().split('T')[0]}.xlsx`;
+            document.body.appendChild(a);
+            a.click();
+            window.URL.revokeObjectURL(url);
+            document.body.removeChild(a);
+
+            toast({ title: "تم التصدير بنجاح" });
+        } catch (error) {
+            console.error("Export failed", error);
+            toast({ variant: 'destructive', title: "فشل التصدير" });
+        }
+    }, []);
+
+
     const searchAllSales = React.useCallback(async (search: string = "") => {
         try {
             const params = new URLSearchParams({ search });
@@ -2115,6 +2156,7 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
             loginDoctor, logoutDoctor, searchMedicationForDoctor, addDoctorSuggestion,
             currentDoctor, isAuthenticatedDoctor,
             impersonateUser, getRandomStocktakeItems, updateMedicationStock,
+            exportSales,
         }}>
             {children}
         </AuthContext.Provider>

commit d66f6e59368314db57d564dc769ca5bdc7f6fec5
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Sat Jan 31 17:05:28 2026 +0100

    feat: Implement HR management page with user and permission management, add new sales page, app shell, and core type definitions.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 43be035..3e4dc73 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -652,6 +652,7 @@ export default function SalesPage() {
     const isOnline = useOnlineStatus();
     const priceModificationAllowed = currentUser?.role === 'Admin' || currentUser?.permissions?.manage_salesPriceModification;
     const canManagePreviousSales = currentUser?.role === 'Admin' || currentUser?.permissions?.manage_previous_sales;
+    const canApplyDiscount = currentUser?.role === 'Admin' || currentUser?.permissions?.manage_salesDiscount;
 
     const { toast } = useToast()
 
@@ -1916,10 +1917,11 @@ export default function SalesPage() {
                                         placeholder="0"
                                         inputMode="decimal"
                                         pattern="[0-9]*\.?[0-9]*"
+                                        disabled={!canApplyDiscount}
                                     />
-                                    <RadioGroup defaultValue="fixed" value={discountType} onValueChange={(value: any) => updateActiveInvoice(prev => ({ ...prev, discountType: value }))} className="flex">
-                                        <Button type="button" size="sm" variant={discountType === 'fixed' ? 'secondary' : 'ghost'} onClick={() => updateActiveInvoice(prev => ({ ...prev, discountType: 'fixed' }))}>IQD</Button>
-                                        <Button type="button" size="icon" variant={discountType === 'percentage' ? 'secondary' : 'ghost'} onClick={() => updateActiveInvoice(prev => ({ ...prev, discountType: 'percentage' }))} className="h-9 w-9"><Percent className="h-4 w-4" /></Button>
+                                    <RadioGroup defaultValue="fixed" value={discountType} onValueChange={(value: any) => updateActiveInvoice(prev => ({ ...prev, discountType: value }))} className="flex" disabled={!canApplyDiscount}>
+                                        <Button type="button" size="sm" variant={discountType === 'fixed' ? 'secondary' : 'ghost'} onClick={() => updateActiveInvoice(prev => ({ ...prev, discountType: 'fixed' }))} disabled={!canApplyDiscount}>IQD</Button>
+                                        <Button type="button" size="icon" variant={discountType === 'percentage' ? 'secondary' : 'ghost'} onClick={() => updateActiveInvoice(prev => ({ ...prev, discountType: 'percentage' }))} className="h-9 w-9" disabled={!canApplyDiscount}><Percent className="h-4 w-4" /></Button>
                                     </RadioGroup>
                                 </div>
                                 <Separator />
diff --git a/src/lib/types.ts b/src/lib/types.ts
index 004d1e5..edc6ee2 100644
--- a/src/lib/types.ts
+++ b/src/lib/types.ts
@@ -62,6 +62,7 @@ export type UserPermissions = {
   manage_exchange: boolean;
   manage_doctors: boolean;
   manage_sales_performance_period: boolean;
+  manage_salesDiscount: boolean;
 };
 
 export type Notification = {

commit 180508dc322912baa77500ed32474ac48026fa7e
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Fri Jan 30 21:10:44 2026 +0100

    feat: Introduce `useAuth` hook for authentication and comprehensive data management, and add initial purchases and sales pages.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 904330e..43be035 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -580,7 +580,7 @@ export default function SalesPage() {
     const handleBarcodeScan = (result: string) => {
         setBarcodeSearchTerm(result);
         setIsBarcodeScannerOpen(false);
-        // Optional: Trigger search immediately if needed, but for now just populate input
+        processBarcode(result);
     };
 
     const [isPatientModalOpen, setIsPatientModalOpen] = React.useState(false);
diff --git a/src/hooks/use-auth.tsx b/src/hooks/use-auth.tsx
index 402c160..eb17a5d 100644
--- a/src/hooks/use-auth.tsx
+++ b/src/hooks/use-auth.tsx
@@ -158,7 +158,7 @@ interface AuthContextType {
     deletePurchaseOrder: (orderId: string) => Promise<boolean>;
     addReturnOrder: (data: any) => Promise<boolean>;
     deleteReturnOrder: (orderId: string) => Promise<boolean>;
-    getPaginatedPurchaseOrders: (page: number, perPage: number, search: string, dateFrom?: string, dateTo?: string, hasReturns?: boolean, paymentStatus?: string) => Promise<PaginatedResponse<PurchaseOrder>>;
+    getPaginatedPurchaseOrders: (page: number, perPage: number, search: string, dateFrom?: string, dateTo?: string, hasReturns?: boolean, paymentStatus?: string, hasBonus?: boolean) => Promise<PaginatedResponse<PurchaseOrder>>;
     getPaginatedReturnOrders: (page: number, perPage: number, search: string, dateFrom?: string, dateTo?: string) => Promise<PaginatedResponse<ReturnOrder>>;
 
     // Expenses
@@ -1052,7 +1052,7 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
         }
     }, []);
 
-    const getPaginatedPurchaseOrders = React.useCallback(async (page: number, perPage: number, search: string, dateFrom?: string, dateTo?: string, hasReturns?: boolean, paymentStatus?: string) => {
+    const getPaginatedPurchaseOrders = React.useCallback(async (page: number, perPage: number, search: string, dateFrom?: string, dateTo?: string, hasReturns?: boolean, paymentStatus?: string, hasBonus?: boolean) => {
         try {
             const params = new URLSearchParams({
                 paginate: "true",
@@ -1063,6 +1063,7 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
             if (dateFrom) params.append('date_from', dateFrom);
             if (dateTo) params.append('date_to', dateTo);
             if (hasReturns) params.append('has_returns', 'true');
+            if (hasBonus) params.append('has_bonus', 'true');
             if (paymentStatus && paymentStatus !== 'all') params.append('payment_status', paymentStatus);
 
             const data = await apiRequest(`/purchase-orders?${params.toString()}`);

commit b2fb77d97c3f1d3e44ebbaf2aaf3dca9ae21cce6
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Wed Jan 28 17:23:47 2026 +0100

    feat: add notes field to purchase orders

diff --git a/src/lib/types.ts b/src/lib/types.ts
index fc0542e..004d1e5 100644
--- a/src/lib/types.ts
+++ b/src/lib/types.ts
@@ -239,6 +239,7 @@ export type PurchaseOrder = {
   status: "Pending" | "Received" | "Cancelled";
   payment_status?: "Paid" | "Unpaid" | "Partial";
   total_amount: number;
+  notes?: string;
 };
 
 export type ReturnOrderItem = {

commit 148ba57af556d8578e24087163c5f3ea30af8c2d
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Tue Jan 27 21:04:15 2026 +0100

    feat: add date range filtering to item movements page

diff --git a/src/hooks/use-auth.tsx b/src/hooks/use-auth.tsx
index 6333db5..402c160 100644
--- a/src/hooks/use-auth.tsx
+++ b/src/hooks/use-auth.tsx
@@ -188,7 +188,7 @@ interface AuthContextType {
     // Users (for SuperAdmin)
     getPaginatedUsers: (role: 'Admin' | 'Employee', page: number, perPage: number, search: string, filters?: { status?: string, province?: string }) => Promise<PaginatedResponse<User>>;
 
-    getPaginatedItemMovements: (page: number, perPage: number, type: string, medication_id?: string, scientificName?: string) => Promise<PaginatedResponse<TransactionHistoryItem>>;
+    getPaginatedItemMovements: (page: number, perPage: number, type: string, medication_id?: string, scientificName?: string, dateFrom?: string, dateTo?: string) => Promise<PaginatedResponse<TransactionHistoryItem>>;
     getMedicationMovements: (medId: string) => Promise<TransactionHistoryItem[]>;
 
     // Multi-invoice state
@@ -931,7 +931,7 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
     }, []);
 
     // Update getPaginatedItemMovements to handle medication_id and type
-    const getPaginatedItemMovements = React.useCallback(async (page: number, perPage: number, type: string, medicationId?: string, scientificName?: string) => {
+    const getPaginatedItemMovements = React.useCallback(async (page: number, perPage: number, type: string, medicationId?: string, scientificName?: string, dateFrom?: string, dateTo?: string) => {
         try {
             const params = new URLSearchParams({
                 paginate: "true",
@@ -941,6 +941,8 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
             if (type) params.append('type', type);
             if (medicationId) params.append('medication_id', medicationId);
             if (scientificName) params.append('scientific_name', scientificName);
+            if (dateFrom) params.append('date_from', dateFrom);
+            if (dateTo) params.append('date_to', dateTo);
 
             const data = await apiRequest(`/item-movements?${params.toString()}`);
             return data;

commit 74141dc7ec6d075e565a79186c5d4aaff8b04bb3
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Mon Jan 26 23:43:00 2026 +0100

    feat: Implement a sales reports page with filtering, printing, and deletion capabilities, and introduce a reusable date picker component.

diff --git a/src/app/reports/page.tsx b/src/app/reports/page.tsx
index 5088c7b..e6c96f4 100644
--- a/src/app/reports/page.tsx
+++ b/src/app/reports/page.tsx
@@ -46,6 +46,7 @@ import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@
 import { PinDialog } from '@/components/auth/PinDialog';
 import Link from 'next/link';
 import { useToast } from '@/hooks/use-toast';
+import { DatePicker } from "@/components/ui/date-picker";
 
 
 // Modern print function that works with React 18+
@@ -363,7 +364,7 @@ export default function ReportsPage() {
                     <>
                         <Card className="flex flex-col justify-center">
                             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
-                                <CardTitle className="text-sm font-medium">إجمالي قيمة المبيعات (المعروضة)</CardTitle>
+                                <CardTitle className="text-sm font-medium">إجمالي قيمة المبيعات</CardTitle>
                                 <DollarSign className="h-4 w-4 text-muted-foreground" />
                             </CardHeader>
                             <CardContent>
@@ -372,7 +373,7 @@ export default function ReportsPage() {
                         </Card>
                         <Card className="flex flex-col justify-center">
                             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
-                                <CardTitle className="text-sm font-medium">صافي الربح (المعروض)</CardTitle>
+                                <CardTitle className="text-sm font-medium">صافي الربح</CardTitle>
                                 <TrendingUp className="h-4 w-4 text-green-600" />
                             </CardHeader>
                             <CardContent>
@@ -423,11 +424,21 @@ export default function ReportsPage() {
                         </div>
                         <div className="space-y-2">
                             <Label htmlFor="date-from">من تاريخ</Label>
-                            <Input id="date-from" type="date" value={dateFrom} onChange={e => setDateFrom(e.target.value)} />
+                            <DatePicker 
+                                id="date-from" 
+                                value={dateFrom} 
+                                onChange={(value: string) => setDateFrom(value)} 
+                                showTime
+                            />
                         </div>
                         <div className="space-y-2">
                             <Label htmlFor="date-to">إلى تاريخ</Label>
-                            <Input id="date-to" type="date" value={dateTo} onChange={e => setDateTo(e.target.value)} />
+                             <DatePicker 
+                                id="date-to" 
+                                value={dateTo} 
+                                onChange={(value: string) => setDateTo(value)} 
+                                showTime
+                            />
                         </div>
                         <div className="space-y-2">
                             <Label htmlFor="employee-filter">الموظف</Label>

commit 79b0aaa11fca5ba55efc70494d208784092cdff0
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Mon Jan 26 09:55:51 2026 +0100

    feat: add sales reports page with filtering, printing, and deletion capabilities.

diff --git a/src/app/reports/page.tsx b/src/app/reports/page.tsx
index 0adf6ed..5088c7b 100644
--- a/src/app/reports/page.tsx
+++ b/src/app/reports/page.tsx
@@ -172,8 +172,8 @@ export default function ReportsPage() {
             setCurrentPage(data.current_page);
 
             if (data.totals) {
-                setTotalSalesDisplayed(data.totals.total_sales);
-                setTotalProfitDisplayed(data.totals.total_profit);
+                setTotalSalesDisplayed(data.totals.total_sales || 0);
+                setTotalProfitDisplayed(data.totals.total_profit || 0);
             } else {
                 const pageSales = filteredData.reduce((acc, sale) => {
                     const total = typeof sale.total === 'number' ? sale.total : parseFloat(String(sale.total || 0));

commit c03a02e78a820afdf44cf7faa1145bea47baa09d
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Mon Jan 26 09:23:38 2026 +0100

    feat: Implement initial application modules for various domains and add authentication components.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 36fb6b9..904330e 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -2182,7 +2182,7 @@ export default function SalesPage() {
                             </div>
                             <DialogFooter>
                                 <DialogClose asChild><Button variant="outline">إلغاء</Button></DialogClose>
-                                <Button variant="destructive" onClick={() => handleControlledDrugPinConfirm()}>تأكيد ومتابعة</Button>
+                                <Button className="mb-2 md:mb-0" variant="destructive" onClick={() => handleControlledDrugPinConfirm()}>تأكيد ومتابعة</Button>
                             </DialogFooter>
                         </DialogContent>
                     </Dialog>

commit c2b11e6f71439f75539324132774abd1c60b5e4b
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Mon Jan 26 08:40:40 2026 +0100

    feat: Implement sales/POS page with medication management, dose calculation, and barcode scanning.

diff --git a/src/app/sales/page.tsx b/src/app/sales/page.tsx
index 5212dbc..36fb6b9 100644
--- a/src/app/sales/page.tsx
+++ b/src/app/sales/page.tsx
@@ -1320,6 +1320,7 @@ export default function SalesPage() {
                 <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 md:h-[calc(100vh-6rem)]">
                     <div className="lg:col-span-2 flex flex-col gap-4">
                         <div className="flex gap-2 flex-col md:flex-row">
+                            {/* --- Section 1: Name Search --- */}
                             <div className="relative flex-[2]">
                                 <Input
                                     placeholder="ابحث بالاسم التجاري أو العلمي..."
@@ -1376,6 +1377,8 @@ export default function SalesPage() {
                                     </Card>
                                 )}
                             </div>
+
+                            {/* --- Section 2: Barcode Search --- */}
                             <div className="relative flex-1">
                                 <Input
                                     placeholder="امسح الباركود..."
@@ -1401,50 +1404,59 @@ export default function SalesPage() {
                                     <ScanBarcode className="h-4 w-4" />
                                 </Button>
                             </div>
-                            <SearchHistoryPopover onSelect={(term) => {
-                                setNameSearchTerm(term);
-                                handleNameSearchChange({ target: { value: term } } as React.ChangeEvent<HTMLInputElement>);
-                            }} />
-                            <Button variant="outline" size="icon" className="shrink-0" onClick={() => setIsBranchSearchOpen(true)}>
-                                <ArrowLeftRight />
-                            </Button>
-
-                            <Tooltip>
-                                <TooltipTrigger asChild>
-                                    <Button variant="outline" size="icon" className="shrink-0 text-blue-500 border-blue-500 hover:bg-blue-500 hover:text-white" onClick={handleOpenPatientMeds} disabled={!patientId}>
-                                        <Pill />
-                                    </Button>
-                                </TooltipTrigger>
-                                <TooltipContent>أدوية المريض المفضلة</TooltipContent>
-                            </Tooltip>
-
-                            <FavoritesPopover onSelect={addToCart} />
-                            <Popover>
-                                <PopoverTrigger asChild>
-                                    <Button variant="outline" size="icon" className="shrink-0"><BrainCircuit /></Button>
-                                </PopoverTrigger>
-                                <PopoverContent className="w-auto p-0" align="start">
-                                    <div className="flex flex-col gap-1">
-                                        {referenceSites.map((site) => (
-                                            <Dialog key={site.name}>
-                                                <DialogTrigger asChild>
-                                                    <Button variant="ghost" className="justify-start">{site.name}</Button>
-                                                </DialogTrigger>
-                                                <DialogContent className="p-0 border-0 sm:max-w-[400px] h-[70vh] flex flex-col gap-0">
-                                                    <DialogHeader className="sr-only">
-                                                        <DialogTitle>{site.name}</DialogTitle>
-                                                    </DialogHeader>
-                                                    <iframe src={site.url} title={site.name} className="w-full h-full" />
-                                                </DialogContent>
-                                            </Dialog>
-                                        ))}
-                                    </div>
-                                </PopoverContent>
-                            </Popover>
-                            <Button variant="secondary" onClick={handleReviewClick}>
-                                <FileText className="me-2" />
-                                مراجعة الفواتير
-                            </Button>
+
+                            {/* --- Section 3: Buttons Wrapper (THE FIX) --- */}
+                            {/* I added this div to wrap all buttons. On mobile, this div is a row. On desktop, it joins the main row. */}
+                            <div className="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1 md:pb-0">
+                                
+                                <SearchHistoryPopover onSelect={(term) => {
+                                    setNameSearchTerm(term);
+                                    handleNameSearchChange({ target: { value: term } } as React.ChangeEvent<HTMLInputElement>);
+                                }} />
+
+                                <Button variant="outline" size="icon" className="shrink-0" onClick={() => setIsBranchSearchOpen(true)}>
+                                    <ArrowLeftRight />
+                                </Button>
+
+                                <Tooltip>
+                                    <TooltipTrigger asChild>
+                                        <Button variant="outline" size="icon" className="shrink-0 text-blue-500 border-blue-500 hover:bg-blue-500 hover:text-white" onClick={handleOpenPatientMeds} disabled={!patientId}>
+                                            <Pill />
+                                        </Button>
+                                    </TooltipTrigger>
+                                    <TooltipContent>أدوية المريض المفضلة</TooltipContent>
+                                </Tooltip>
+
+                                <FavoritesPopover onSelect={addToCart} />
+
+                                <Popover>
+                                    <PopoverTrigger asChild>
+                                        <Button variant="outline" size="icon" className="shrink-0"><BrainCircuit /></Button>
+                                    </PopoverTrigger>
+                                    <PopoverContent className="w-auto p-0" align="start">
+                                        <div className="flex flex-col gap-1">
+                                            {referenceSites.map((site) => (
+                                                <Dialog key={site.name}>
+                                                    <DialogTrigger asChild>
+                                                        <Button variant="ghost" className="justify-start">{site.name}</Button>
+                                                    </DialogTrigger>
+                                                    <DialogContent className="p-0 border-0 sm:max-w-[400px] h-[70vh] flex flex-col gap-0">
+                                                        <DialogHeader className="sr-only">
+                                                            <DialogTitle>{site.name}</DialogTitle>
+                                                        </DialogHeader>
+                                                        <iframe src={site.url} title={site.name} className="w-full h-full" />
+                                                    </DialogContent>
+                                                </Dialog>
+                                            ))}
+                                        </div>
+                                    </PopoverContent>
+                                </Popover>
+
+                                <Button variant="secondary" className="whitespace-nowrap" onClick={handleReviewClick}>
+                                    <FileText className="me-2" />
+                                    مراجعة الفواتير
+                                </Button>
+                            </div>
                         </div>
 
                         <Card className="flex-1 flex flex-col">

commit 3026f438ce4f6cbaf060ff681ea564b72f12bd81
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Sun Jan 25 22:34:14 2026 +0100

    feat: introduce `useAuth` hook for centralized authentication and application data management, and add the initial reports page.

diff --git a/src/app/reports/page.tsx b/src/app/reports/page.tsx
index 5c089ee..0adf6ed 100644
--- a/src/app/reports/page.tsx
+++ b/src/app/reports/page.tsx
@@ -286,7 +286,7 @@ export default function ReportsPage() {
                 doctorId: saleToEdit.doctor_id || null,
                 paymentMethod: saleToEdit.payment_method || 'cash',
                 saleIdToUpdate: saleToEdit.id,
-            }));
+            }), 0);
             router.push('/sales');
         }
     };
diff --git a/src/hooks/use-auth.tsx b/src/hooks/use-auth.tsx
index 63f89d0..6333db5 100644
--- a/src/hooks/use-auth.tsx
+++ b/src/hooks/use-auth.tsx
@@ -194,7 +194,7 @@ interface AuthContextType {
     // Multi-invoice state
     activeInvoices: ActiveInvoice[];
     currentInvoiceIndex: number;
-    updateActiveInvoice: (updater: (invoice: ActiveInvoice) => ActiveInvoice) => void;
+    updateActiveInvoice: (updater: (invoice: ActiveInvoice) => ActiveInvoice, targetIndex?: number) => void;
     switchToInvoice: (index: number) => void;
     createNewInvoice: () => void;
     closeInvoice: (index: number, isAfterSale?: boolean) => void;
@@ -570,10 +570,10 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
         }
     };
 
-    const updateActiveInvoice = React.useCallback((updater: (invoice: ActiveInvoice) => ActiveInvoice) => {
+    const updateActiveInvoice = React.useCallback((updater: (invoice: ActiveInvoice) => ActiveInvoice, targetIndex?: number) => {
         setActiveInvoices(prevInvoices =>
             prevInvoices.map((invoice, index) =>
-                index === currentInvoiceIndex ? updater(invoice) : invoice
+                index === (targetIndex !== undefined ? targetIndex : currentInvoiceIndex) ? updater(invoice) : invoice
             )
         );
     }, [currentInvoiceIndex]);

commit a87805b67c579e5fbdc466281b7fb19175e50ecb
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Sun Jan 25 19:53:43 2026 +0100

    feat: Implement comprehensive purchase and return order management, including history, inventory integration, and a new reports page, along with core authentication and data types.

diff --git a/src/app/reports/page.tsx b/src/app/reports/page.tsx
index bdc28ec..5c089ee 100644
--- a/src/app/reports/page.tsx
+++ b/src/app/reports/page.tsx
@@ -115,6 +115,8 @@ export default function ReportsPage() {
     const [patients, setPatients] = React.useState<any[]>([]);
     const [allPatients, setAllPatients] = React.useState<Patient[]>([]);
     const [doctors, setDoctors] = React.useState<any[]>([]);
+    const [totalSalesDisplayed, setTotalSalesDisplayed] = React.useState(0);
+    const [totalProfitDisplayed, setTotalProfitDisplayed] = React.useState(0);
 
     const [searchTerm, setSearchTerm] = React.useState("");
     const [isClient, setIsClient] = React.useState(false);
@@ -168,6 +170,23 @@ export default function ReportsPage() {
             setSales(filteredData);
             setTotalPages(data.last_page);
             setCurrentPage(data.current_page);
+
+            if (data.totals) {
+                setTotalSalesDisplayed(data.totals.total_sales);
+                setTotalProfitDisplayed(data.totals.total_profit);
+            } else {
+                const pageSales = filteredData.reduce((acc, sale) => {
+                    const total = typeof sale.total === 'number' ? sale.total : parseFloat(String(sale.total || 0));
+                    return acc + (isNaN(total) ? 0 : total);
+                }, 0);
+                const pageProfit = filteredData.reduce((acc, sale) => {
+                    const total = (typeof sale.profit === 'number' ? sale.profit : parseFloat(String(sale.profit || 0))) -
+                        (typeof sale.discount === 'number' ? sale.discount : parseFloat(String(sale.discount || 0)));
+                    return acc + (isNaN(total) ? 0 : total);
+                }, 0);
+                setTotalSalesDisplayed(pageSales);
+                setTotalProfitDisplayed(pageProfit);
+            }
         } catch (error) {
             console.error("Failed to fetch sales", error);
         } finally {
@@ -272,15 +291,9 @@ export default function ReportsPage() {
         }
     };
 
-    const totalSalesValue = sales.reduce((acc, sale) => {
-        const total = typeof sale.total === 'number' ? sale.total : parseFloat(String(sale.total || 0));
-        return acc + (isNaN(total) ? 0 : total);
-    }, 0);
-    const totalProfit = sales.reduce((acc, sale) => {
-        const total = (typeof sale.profit === 'number' ? sale.profit : parseFloat(String(sale.profit || 0))) -
-            (typeof sale.discount === 'number' ? sale.discount : parseFloat(String(sale.discount || 0)));
-        return acc + (isNaN(total) ? 0 : total);
-    }, 0);
+
+
+    // Removed client-side calculation. Using API values.
 
     const pharmacyUsers = React.useMemo(() => {
         return users.filter(u => u.pharmacy_id === currentUser?.pharmacy_id);
@@ -354,7 +367,7 @@ export default function ReportsPage() {
                                 <DollarSign className="h-4 w-4 text-muted-foreground" />
                             </CardHeader>
                             <CardContent>
-                                <div className="text-2xl font-bold font-mono">{totalSalesValue.toLocaleString()}</div>
+                                <div className="text-2xl font-bold font-mono">{totalSalesDisplayed.toLocaleString()}</div>
                             </CardContent>
                         </Card>
                         <Card className="flex flex-col justify-center">
@@ -363,7 +376,7 @@ export default function ReportsPage() {
                                 <TrendingUp className="h-4 w-4 text-green-600" />
                             </CardHeader>
                             <CardContent>
-                                <div className="text-2xl font-bold text-green-600 font-mono">{totalProfit.toLocaleString()}</div>
+                                <div className="text-2xl font-bold text-green-600 font-mono">{totalProfitDisplayed.toLocaleString()}</div>
                             </CardContent>
                         </Card>
                     </>
diff --git a/src/hooks/use-auth.tsx b/src/hooks/use-auth.tsx
index cc4be88..63f89d0 100644
--- a/src/hooks/use-auth.tsx
+++ b/src/hooks/use-auth.tsx
@@ -123,7 +123,7 @@ interface AuthContextType {
     addSale: (saleData: any) => Promise<Sale | null>;
     updateSale: (saleData: any) => Promise<Sale | null>;
     deleteSale: (saleId: string) => Promise<boolean>;
-    getPaginatedSales: (page: number, perPage: number, search: string, dateFrom: string, dateTo: string, employeeId: string, paymentMethod: string, doctorId: string, patientId: string) => Promise<PaginatedResponse<Sale>>;
+    getPaginatedSales: (page: number, perPage: number, search: string, dateFrom: string, dateTo: string, employeeId: string, paymentMethod: string, doctorId: string, patientId: string) => Promise<PaginatedResponse<Sale> & { totals?: { total_sales: number, total_profit: number } }>;
     searchAllSales: (search?: string) => Promise<Sale[]>;
 
     // Suppliers
@@ -1037,7 +1037,7 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
             const data = await apiRequest(`/sales?${params.toString()}`);
             return data;
         } catch (e) {
-            return { data: [], current_page: 1, last_page: 1 } as unknown as PaginatedResponse<Sale>;
+            return { data: [], current_page: 1, last_page: 1 } as unknown as PaginatedResponse<Sale> & { totals?: { total_sales: number, total_profit: number } };
         }
     }, []);
 
diff --git a/src/lib/types.ts b/src/lib/types.ts
index 7a514aa..fc0542e 100644
--- a/src/lib/types.ts
+++ b/src/lib/types.ts
@@ -225,6 +225,8 @@ export type PurchaseOrderItem = {
   strip_purchase_price: number;  // سعر شراء الشريط (calculated)
   box_sell_price: number;        // سعر بيع العلبة
   strip_sell_price: number;      // سعر بيع الشريط
+  bonus_boxes?: number;          // عدد العلب المجانية
+  net_cost_per_box?: number;     // صافي التكلفة للعلبة الواحدة
 };
 
 export type PurchaseOrder = {

commit 521e5c0314514c867aeaf3addbf0fe5bb196ab49
Author: elhareth0609 <elhareth0609@gmail.com>
Date:   Fri Jan 16 09:22:42 2026 +0100

    feat: Introduce `useAuth` hook for authentication and data management, and add new stocktake page and application shell.

diff --git a/src/hooks/use-auth.tsx b/src/hooks/use-auth.tsx
index 72e2366..cc4be88 100644
--- a/src/hooks/use-auth.tsx
+++ b/src/hooks/use-auth.tsx
@@ -93,6 +93,7 @@ interface AuthContextType {
     // Inventory Management
     addMedication: (data: Partial<Medication>) => Promise<Medication | null>;
     updateMedication: (medId: string, data: Partial<Medication>) => Promise<Medication | null>;
+    updateMedicationStock: (medId: string, stock: number) => Promise<boolean>;
     deleteMedication: (medId: string) => Promise<boolean>;
     markAsDamaged: (medId: string) => Promise<boolean>;
     bulkAddOrUpdateInventory: (items: Partial<Medication>[]) => Promise<{ new_count: number; updated_count?: number; } | null>;
@@ -101,7 +102,7 @@ interface AuthContextType {
     searchAllInventory: (search: string) => Promise<Medication[]>;
     toggleFavoriteMedication: (medId: string) => Promise<void>;
     searchInOtherBranches: (medicationName: string) => Promise<BranchInventory[]>;
-    getRandomStocktakeItems: (count: number) => Promise<Medication[]>;
+    getRandomStocktakeItems: (limit: number) => Promise<Medication[]>;
 
     // Central Drug Management (SuperAdmin)
     getCentralDrugs: (page: number, perPage: number, search: string) => Promise<PaginatedResponse<Medication>>;
@@ -2028,17 +2029,27 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
         }
     }, []);
 
-    const getRandomStocktakeItems = React.useCallback(async (count: number): Promise<Medication[]> => {
+    const updateMedicationStock = async (id: string, stock: number) => {
         try {
-            const fullInventoryList = await searchAllInventory('');
-            if (fullInventoryList.length === 0) return [];
-            // Shuffle the array and take the first 'count' items
-            const shuffled = fullInventoryList.sort(() => 0.5 - Math.random());
-            return shuffled.slice(0, count);
+            const updatedItem = await apiRequest(`/medications/${id}/stock`, 'PUT', { stock });
+            setInventory(prev => prev.map(item => item.id === id ? updatedItem : item));
+            toast({ title: "تم تحديث المخزون بنجاح" });
+            return true;
+        } catch (e) { return false; }
+    };
+
+    const getRandomStocktakeItems = React.useCallback(async (limit: number = 10): Promise<Medication[]> => {
+        try {
+            const params = new URLSearchParams({
+                limit: String(limit),
+            });
+
+            const result = await apiRequest(`/spot-check?${params.toString()}`);
+            return result || [];
         } catch (e) {
             return [];
         }
-    }, [searchAllInventory]);
+    }, []);
 
     const scopedData: ScopedDataContextType = {
         inventory: [inventory, setInventory],
@@ -2100,7 +2111,7 @@ export function AuthProvider({ children }: { children: React.ReactNode }) {
             getDoctors, addDoctor, updateDoctor, deleteDoctor, getDoctorSuggestions,
             loginDoctor, logoutDoctor, searchMedicationForDoctor, addDoctorSuggestion,
             currentDoctor, isAuthenticatedDoctor,
-            impersonateUser, getRandomStocktakeItems,
+            impersonateUser, getRandomStocktakeItems, updateMedicationStock,
         }}>
             {children}
         </AuthContext.Provider>
